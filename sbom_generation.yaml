# Copyright (c) 2023, Oracle and/or its affiliates. All rights reserved.

version: 0.1
component: build
timeoutInSeconds: 1000
shell: bash
env:
  variables:
    PYTHON_CMD: "python3"
    CDXGEN_DEBUG_MODE: "debug"

steps:
  - type: Command
    name: "Download the version 10.10.0 of cdxgen globally"
    command: |
      npm install -g @cyclonedx/cdxgen@10.10.0
      gcc --version

  - type: Command
    name: "Workaround to let cdxgen run on nodejs 16"
    command: |
      # cdxgen relies on a fourth-party dependency that cannot be executed in a Node.js environment running version 16
      # (as installed on the build runner instance)
      # This is a workaround to ensure cdxgen functions correctly, even in an older Node.js environment.
      cd /node/node-v16.14.2-linux-x64/lib/node_modules/@cyclonedx/cdxgen
      npm install cheerio@v1.0.0-rc.12
      yum -y install oracle-softwarecollection-release-el7
      yum -y install devtoolset-10
      yum -y install rh-python38
      source /opt/rh/devtoolset-10/enable
      source /opt/rh/rh-python38/enable
      python3 -m ensurepip --upgrade
      python3 -m pip install cmake --upgrade

  - type: Command
    name: "Generate SBOM for Python"
    command: |
      source /opt/rh/devtoolset-10/enable
      source /opt/rh/rh-python38/enable
      python3 -v
      pip --version 
      PYTHON_INCLUDE_DIR=$(python3 -c "import sysconfig; print(sysconfig.get_path('include'))")
      PYTHON_LIBRARY=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))") 
      cd hiq
      cdxgen -t python3 -o artifactSBOM.json --spec-version 1.4 --project-name "hiq" --no-recurse
      mv artifactSBOM.json ${OCI_PRIMARY_SOURCE_DIR}/artifactSBOM.json

outputArtifacts:
  - name: artifactSBOM
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/artifactSBOM.json
